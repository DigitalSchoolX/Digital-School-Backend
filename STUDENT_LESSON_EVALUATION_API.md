# API ƒê√°nh Gi√° Ti·∫øt H·ªçc C·ªßa H·ªçc Sinh

## T·ªïng quan

API n√†y cho ph√©p h·ªçc sinh ƒë√°nh gi√° c√°c ti·∫øt h·ªçc ƒë√£ ho√†n th√†nh v·ªõi c√°c ƒëi·ªÅu ki·ªán sau:
- ‚úÖ H·ªçc sinh ph·∫£i thu·ªôc l·ªõp c·ªßa ti·∫øt h·ªçc ƒë√≥
- ‚úÖ Ti·∫øt h·ªçc ph·∫£i c√≥ tr·∫°ng th√°i `completed` (ƒë√£ ho√†n th√†nh)
- ‚úÖ H·ªçc sinh ph·∫£i c√≥ m·∫∑t trong ti·∫øt h·ªçc (kh√¥ng v·∫Øng m·∫∑t)
- ‚úÖ M·ªói h·ªçc sinh ch·ªâ ƒë∆∞·ª£c ƒë√°nh gi√° 1 l·∫ßn cho m·ªói ti·∫øt h·ªçc
- ‚úÖ ƒê√°nh gi√° c·ªßa h·ªçc sinh t√°ch bi·ªát v·ªõi ƒë√°nh gi√° c·ªßa gi√°o vi√™n

## Base URL
```
/api/student-evaluations
```

## Authentication
T·∫•t c·∫£ API ƒë·ªÅu y√™u c·∫ßu:
- Header: `Authorization: Bearer <token>`
- Role: `student` (ch·ªâ h·ªçc sinh m·ªõi ƒë∆∞·ª£c truy c·∫≠p)

---

## üìù **1. T·∫°o ƒê√°nh Gi√° Ti·∫øt H·ªçc**

### Endpoint
```http
POST /api/student-evaluations/lessons/{lessonId}/evaluate
```

### Request Body
```json
{
  "teachingClarity": 4,
  "teachingSupport": 5,
  "teacherInteraction": 4,
  "completedWell": true,
  "reason": "Kh√¥ng hi·ªÉu b√†i t·∫≠p v·ªÅ nh√†",
  "comments": "Ti·∫øt h·ªçc r·∫•t hay, gi√°o vi√™n gi·∫£i th√≠ch d·ªÖ hi·ªÉu"
}
```

### Validation Rules
- `teachingClarity`: **Required**, Integer 1-5 (C·∫£m nh·∫≠n v·ªÅ vi·ªác gi·∫£i th√≠ch b√†i h·ªçc)
- `teachingSupport`: **Required**, Integer 1-5 (C·∫£m nh·∫≠n v·ªÅ s·ª± h∆∞·ªõng d·∫´n)
- `teacherInteraction`: **Required**, Integer 1-5 (C·∫£m nh·∫≠n v·ªÅ vi·ªác t∆∞∆°ng t√°c v·ªõi GV)
- `completedWell`: **Required**, Boolean (H·ªçc sinh c√≥ ho√†n th√†nh t·ªët ti·∫øt h·ªçc kh√¥ng)
- `reason`: Optional, String ‚â§200 chars (L√Ω do n·∫øu kh√¥ng ho√†n th√†nh t·ªët)
- `comments`: Optional, String ‚â§500 chars (Ghi ch√∫ th√™m)

### Response Success (201)
```json
{
  "success": true,
  "message": "ƒê√°nh gi√° ti·∫øt h·ªçc th√†nh c√¥ng",
  "data": {
    "evaluationId": "675a1b2c3d4e5f6789012345",
    "lesson": {
      "lessonId": "582827_20241219_0001",
      "scheduledDate": "2024-12-19T00:00:00.000Z",
      "topic": "ƒê·∫°o h√†m c·ªßa h√†m s·ªë"
    },
    "class": "12A1",
    "subject": {
      "name": "To√°n h·ªçc",
      "code": "MATH"
    },
    "teacher": {
      "name": "Nguy·ªÖn VƒÉn Nam",
      "email": "nguyenvannam@school.edu.vn"
    },
    "evaluation": {
      "teachingClarity": 4,
      "teachingSupport": 5,
      "teacherInteraction": 4,
      "overallRating": 4.3
    },
    "studentSelfAssessment": {
      "completedWell": true,
      "reason": null
    },
    "comments": "Ti·∫øt h·ªçc r·∫•t hay, gi√°o vi√™n gi·∫£i th√≠ch d·ªÖ hi·ªÉu",
    "evaluatedAt": "2024-12-20T10:30:00.000Z"
  }
}
```

### Response Error (403)
```json
{
  "success": false,
  "message": "Student does not belong to this class"
}
```

---

## ‚úèÔ∏è **2. C·∫≠p Nh·∫≠t ƒê√°nh Gi√°**

### Endpoint
```http
PUT /api/student-evaluations/{evaluationId}
```

### Request Body (t·∫•t c·∫£ field ƒë·ªÅu optional)
```json
{
  "teachingClarity": 5,
  "teachingSupport": 4,
  "comments": "C·∫≠p nh·∫≠t: Gi√°o vi√™n r·∫•t nhi·ªát t√¨nh"
}
```

### Response Success (200)
```json
{
  "success": true,
  "message": "C·∫≠p nh·∫≠t ƒë√°nh gi√° th√†nh c√¥ng",
  "data": {
    "evaluationId": "675a1b2c3d4e5f6789012345",
    "lesson": {
      "lessonId": "582827_20241219_0001",
      "scheduledDate": "2024-12-19T00:00:00.000Z",
      "topic": "ƒê·∫°o h√†m c·ªßa h√†m s·ªë"
    },
    "evaluation": {
      "teachingClarity": 5,
      "teachingSupport": 4,
      "teacherInteraction": 4,
      "overallRating": 4.3
    },
    "studentSelfAssessment": {
      "completedWell": true,
      "reason": null
    },
    "comments": "C·∫≠p nh·∫≠t: Gi√°o vi√™n r·∫•t nhi·ªát t√¨nh",
    "evaluatedAt": "2024-12-20T10:30:00.000Z",
    "updatedAt": "2024-12-20T14:15:00.000Z"
  }
}
```

---

## üìã **3. L·∫•y Danh S√°ch ƒê√°nh Gi√° C·ªßa H·ªçc Sinh**

### Endpoint
```http
GET /api/student-evaluations
```

### Query Parameters
- `classId`: Optional, MongoDB ObjectId (L·ªçc theo l·ªõp)
- `subjectId`: Optional, MongoDB ObjectId (L·ªçc theo m√¥n h·ªçc)
- `teacherId`: Optional, MongoDB ObjectId (L·ªçc theo gi√°o vi√™n)
- `startDate`: Optional, ISO 8601 date (T·ª´ ng√†y)
- `endDate`: Optional, ISO 8601 date (ƒê·∫øn ng√†y)
- `page`: Optional, Integer ‚â•1 (Trang hi·ªán t·∫°i, default: 1)
- `limit`: Optional, Integer 1-100 (S·ªë item/trang, default: 20)

### Example Request
```http
GET /api/student-evaluations?subjectId=675a1b2c3d4e5f6789012347&page=1&limit=10
```

### Response Success (200)
```json
{
  "success": true,
  "message": "L·∫•y danh s√°ch ƒë√°nh gi√° th√†nh c√¥ng",
  "data": {
    "evaluations": [
      {
        "evaluationId": "675a1b2c3d4e5f6789012345",
        "lesson": {
          "lessonId": "582827_20241219_0001",
          "scheduledDate": "2024-12-19T00:00:00.000Z",
          "topic": "ƒê·∫°o h√†m c·ªßa h√†m s·ªë",
          "status": "completed"
        },
        "class": "12A1",
        "subject": {
          "name": "To√°n h·ªçc",
          "code": "MATH"
        },
        "teacher": {
          "name": "Nguy·ªÖn VƒÉn Nam",
          "email": "nguyenvannam@school.edu.vn"
        },
        "evaluation": {
          "teachingClarity": 4,
          "teachingSupport": 5,
          "teacherInteraction": 4,
          "overallRating": 4.3
        },
        "studentSelfAssessment": {
          "completedWell": true,
          "reason": null
        },
        "comments": "Ti·∫øt h·ªçc r·∫•t hay",
        "evaluatedAt": "2024-12-20T10:30:00.000Z"
      }
    ]
  },
  "pagination": {
    "currentPage": 1,
    "totalPages": 3,
    "totalItems": 25,
    "itemsPerPage": 10,
    "hasNextPage": true,
    "hasPrevPage": false
  }
}
```

---

## üîç **4. L·∫•y Chi Ti·∫øt M·ªôt ƒê√°nh Gi√°**

### Endpoint
```http
GET /api/student-evaluations/{evaluationId}
```

### Response Success (200)
```json
{
  "success": true,
  "message": "L·∫•y chi ti·∫øt ƒë√°nh gi√° th√†nh c√¥ng",
  "data": {
    "evaluationId": "675a1b2c3d4e5f6789012345",
    "lesson": {
      "lessonId": "582827_20241219_0001",
      "scheduledDate": "2024-12-19T00:00:00.000Z",
      "actualDate": "2024-12-19T07:00:00.000Z",
      "topic": "ƒê·∫°o h√†m c·ªßa h√†m s·ªë",
      "status": "completed",
      "notes": "Ho√†n th√†nh ch∆∞∆°ng tr√¨nh theo k·∫ø ho·∫°ch"
    },
    "class": {
      "name": "12A1",
      "academicYear": "2024-2025"
    },
    "subject": {
      "name": "To√°n h·ªçc",
      "code": "MATH"
    },
    "teacher": {
      "name": "Nguy·ªÖn VƒÉn Nam",
      "email": "nguyenvannam@school.edu.vn"
    },
    "evaluation": {
      "teachingClarity": 4,
      "teachingSupport": 5,
      "teacherInteraction": 4,
      "overallRating": 4.3
    },
    "studentSelfAssessment": {
      "completedWell": true,
      "reason": null
    },
    "comments": "Ti·∫øt h·ªçc r·∫•t hay, gi√°o vi√™n gi·∫£i th√≠ch d·ªÖ hi·ªÉu",
    "evaluatedAt": "2024-12-20T10:30:00.000Z",
    "updatedAt": "2024-12-20T14:15:00.000Z"
  }
}
```

---

## ‚úÖ **5. Ki·ªÉm Tra C√≥ Th·ªÉ ƒê√°nh Gi√° Ti·∫øt H·ªçc Kh√¥ng**

### Endpoint
```http
GET /api/student-evaluations/lessons/{lessonId}/can-evaluate
```

### Response Success (200) - C√≥ th·ªÉ ƒë√°nh gi√°
```json
{
  "success": true,
  "canEvaluate": true,
  "message": "H·ªçc sinh c√≥ th·ªÉ ƒë√°nh gi√° ti·∫øt h·ªçc n√†y",
  "data": {
    "lesson": {
      "lessonId": "582827_20241219_0001",
      "scheduledDate": "2024-12-19T00:00:00.000Z",
      "actualDate": "2024-12-19T07:00:00.000Z",
      "topic": "ƒê·∫°o h√†m c·ªßa h√†m s·ªë",
      "status": "completed"
    },
    "class": "12A1",
    "subject": {
      "name": "To√°n h·ªçc",
      "code": "MATH"
    },
    "teacher": {
      "name": "Nguy·ªÖn VƒÉn Nam",
      "email": "nguyenvannam@school.edu.vn"
    }
  }
}
```

### Response Error (403) - Kh√¥ng th·ªÉ ƒë√°nh gi√°
```json
{
  "success": false,
  "canEvaluate": false,
  "message": "Student has already evaluated this lesson"
}
```

---

## üìö **6. L·∫•y Danh S√°ch Ti·∫øt H·ªçc C√≥ Th·ªÉ ƒê√°nh Gi√°**

### Endpoint
```http
GET /api/student-evaluations/lessons/evaluable
```

### Query Parameters
- `startDate`: Optional, ISO 8601 date (T·ª´ ng√†y)
- `endDate`: Optional, ISO 8601 date (ƒê·∫øn ng√†y)
- `subjectId`: Optional, MongoDB ObjectId (L·ªçc theo m√¥n h·ªçc)
- `page`: Optional, Integer ‚â•1 (Trang hi·ªán t·∫°i, default: 1)
- `limit`: Optional, Integer 1-100 (S·ªë item/trang, default: 20)

### Response Success (200)
```json
{
  "success": true,
  "message": "L·∫•y danh s√°ch ti·∫øt h·ªçc c√≥ th·ªÉ ƒë√°nh gi√° th√†nh c√¥ng",
  "data": {
    "lessons": [
      {
        "lessonId": "675a1b2c3d4e5f6789012346",
        "lessonCode": "582827_20241218_0002",
        "scheduledDate": "2024-12-18T00:00:00.000Z",
        "actualDate": "2024-12-18T08:30:00.000Z",
        "topic": "T√≠ch ph√¢n c·ªßa h√†m s·ªë",
        "subject": {
          "name": "To√°n h·ªçc",
          "code": "MATH"
        },
        "teacher": {
          "name": "Nguy·ªÖn VƒÉn Nam",
          "email": "nguyenvannam@school.edu.vn"
        },
        "canEvaluate": true
      }
    ]
  },
  "pagination": {
    "currentPage": 1,
    "totalPages": 2,
    "totalItems": 8,
    "itemsPerPage": 20,
    "hasNextPage": true,
    "hasPrevPage": false
  }
}
```

---

## üö´ **C√°c Tr∆∞·ªùng H·ª£p L·ªói Ph·ªï Bi·∫øn**

### 1. Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p (403)
```json
{
  "success": false,
  "message": "Access denied. Only students can access this endpoint."
}
```

### 2. Ti·∫øt h·ªçc ch∆∞a ho√†n th√†nh (403)
```json
{
  "success": false,
  "message": "Lesson is not completed yet"
}
```

### 3. H·ªçc sinh kh√¥ng thu·ªôc l·ªõp (403)
```json
{
  "success": false,
  "message": "Student does not belong to this class"
}
```

### 4. H·ªçc sinh v·∫Øng m·∫∑t (403)
```json
{
  "success": false,
  "message": "Student was absent from this lesson"
}
```

### 5. ƒê√£ ƒë√°nh gi√° r·ªìi (403)
```json
{
  "success": false,
  "message": "Student has already evaluated this lesson"
}
```

### 6. Validation l·ªói (400)
```json
{
  "success": false,
  "message": "Validation errors",
  "errors": [
    {
      "field": "teachingClarity",
      "message": "Teaching clarity rating must be an integer between 1 and 5"
    }
  ]
}
```

---

## üìä **Schema ƒê√°nh Gi√°**

### C·∫•u tr√∫c ƒë√°nh gi√° h·ªçc sinh
```json
{
  "evaluation": {
    "teachingClarity": 4,        // 1-5: C·∫£m nh·∫≠n v·ªÅ vi·ªác gi·∫£i th√≠ch b√†i h·ªçc
    "teachingSupport": 5,        // 1-5: C·∫£m nh·∫≠n v·ªÅ s·ª± h∆∞·ªõng d·∫´n
    "teacherInteraction": 4,     // 1-5: C·∫£m nh·∫≠n v·ªÅ vi·ªác t∆∞∆°ng t√°c v·ªõi GV
    "overallRating": 4.3         // T·ª± ƒë·ªông t√≠nh t·ª´ 3 ti√™u ch√≠ tr√™n
  },
  "studentSelfAssessment": {
    "completedWell": true,       // H·ªçc sinh c√≥ ho√†n th√†nh t·ªët ti·∫øt h·ªçc kh√¥ng
    "reason": "Kh√¥ng hi·ªÉu b√†i"   // L√Ω do n·∫øu kh√¥ng ho√†n th√†nh t·ªët
  },
  "comments": "Ghi ch√∫ th√™m t·ª´ h·ªçc sinh"
}
```

---

## üîê **B·∫£o M·∫≠t & R√†ng Bu·ªôc**

### ƒêi·ªÅu ki·ªán ƒë·ªÉ ƒë√°nh gi√°:
1. ‚úÖ User ph·∫£i c√≥ role `student`
2. ‚úÖ Lesson ph·∫£i c√≥ status `completed`
3. ‚úÖ Student ph·∫£i thu·ªôc class c·ªßa lesson
4. ‚úÖ Student ph·∫£i c√≥ m·∫∑t trong lesson (kh√¥ng v·∫Øng)
5. ‚úÖ Student ch∆∞a ƒë√°nh gi√° lesson n√†y tr∆∞·ªõc ƒë√≥

### R√†ng bu·ªôc d·ªØ li·ªáu:
- M·ªói student ch·ªâ ƒë∆∞·ª£c ƒë√°nh gi√° 1 l·∫ßn cho 1 lesson (unique index)
- Rating ph·∫£i l√† s·ªë nguy√™n t·ª´ 1-5
- Comments t·ªëi ƒëa 500 k√Ω t·ª±
- Reason t·ªëi ƒëa 200 k√Ω t·ª±

### Ph√¢n quy·ªÅn:
- Student ch·ªâ c√≥ th·ªÉ xem/s·ª≠a ƒë√°nh gi√° c·ªßa ch√≠nh m√¨nh
- Teacher/Manager c√≥ th·ªÉ xem th·ªëng k√™ ƒë√°nh gi√° (API ri√™ng)

---

## üì± **T√≠ch H·ª£p Frontend**

### Workflow ƒë·ªÅ xu·∫•t:
1. **L·∫•y danh s√°ch ti·∫øt h·ªçc c√≥ th·ªÉ ƒë√°nh gi√°**: `GET /lessons/evaluable`
2. **Ki·ªÉm tra c√≥ th·ªÉ ƒë√°nh gi√°**: `GET /lessons/{id}/can-evaluate`
3. **Hi·ªÉn th·ªã form ƒë√°nh gi√°** v·ªõi 3 c√¢u h·ªèi rating + self-assessment
4. **Submit ƒë√°nh gi√°**: `POST /lessons/{id}/evaluate`
5. **Cho ph√©p c·∫≠p nh·∫≠t**: `PUT /{evaluationId}`

### UI Components g·ª£i √Ω:
- ‚≠ê **Star Rating** cho 3 ti√™u ch√≠ ƒë√°nh gi√°
- ‚úÖ **Toggle/Checkbox** cho "Ho√†n th√†nh t·ªët ti·∫øt h·ªçc"
- üìù **Text Area** cho comments v√† reason
- üìä **Progress Bar** hi·ªÉn th·ªã overall rating

---

## üß™ **Testing**

### Test Cases ch√≠nh:
1. ‚úÖ Student ƒë√°nh gi√° lesson ƒë√£ completed v√† c√≥ m·∫∑t
2. ‚ùå Student ƒë√°nh gi√° lesson ch∆∞a completed
3. ‚ùå Student ƒë√°nh gi√° lesson c·ªßa l·ªõp kh√°c
4. ‚ùå Student ƒë√°nh gi√° lesson m√† m√¨nh v·∫Øng m·∫∑t
5. ‚ùå Student ƒë√°nh gi√° lesson ƒë√£ ƒë√°nh gi√° r·ªìi
6. ‚úÖ Student c·∫≠p nh·∫≠t ƒë√°nh gi√° c·ªßa m√¨nh
7. ‚ùå Student c·∫≠p nh·∫≠t ƒë√°nh gi√° c·ªßa ng∆∞·ªùi kh√°c

### Sample cURL Commands:

#### T·∫°o ƒë√°nh gi√°:
```bash
curl -X POST "http://localhost:5000/api/student-evaluations/lessons/675a1b2c3d4e5f6789012345/evaluate" \
  -H "Authorization: Bearer <student_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "teachingClarity": 4,
    "teachingSupport": 5,
    "teacherInteraction": 4,
    "completedWell": true,
    "comments": "Ti·∫øt h·ªçc r·∫•t hay!"
  }'
```

#### L·∫•y danh s√°ch ƒë√°nh gi√°:
```bash
curl -X GET "http://localhost:5000/api/student-evaluations?page=1&limit=10" \
  -H "Authorization: Bearer <student_token>"
```

---

H·ªá th·ªëng ƒë√°nh gi√° n√†y ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn d·ªØ li·ªáu v√† b·∫£o m·∫≠t, ch·ªâ cho ph√©p h·ªçc sinh ƒë√°nh gi√° nh·ªØng ti·∫øt h·ªçc m√† h·ªç th·ª±c s·ª± tham gia v√† ƒë√£ ho√†n th√†nh. 