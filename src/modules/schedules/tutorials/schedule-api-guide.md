# üìö H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng Schedule API

## üéØ T·ªïng quan

Module Schedule cung c·∫•p c√°c API ƒë·ªÉ qu·∫£n l√Ω th·ªùi kh√≥a bi·ªÉu h·ªçc t·∫≠p. H·ªá th·ªëng ƒë∆∞·ª£c t·ªëi ∆∞u h√≥a ƒë·ªÉ ch·ªâ t·∫°o v√† qu·∫£n l√Ω th·ªùi kh√≥a bi·ªÉu theo t·ª´ng tu·∫ßn, v·ªõi 2 collection ch√≠nh:

- **`weeklySchedules`**: L∆∞u th√¥ng tin tu·∫ßn h·ªçc
- **`lessons`**: L∆∞u chi ti·∫øt t·ª´ng ti·∫øt h·ªçc

## üîê Authentication

T·∫•t c·∫£ API ƒë·ªÅu y√™u c·∫ßu authentication token trong header:

```
Authorization: Bearer <your_jwt_token>
```

## üìã Danh s√°ch API

### 1. T·∫°o th·ªùi kh√≥a bi·ªÉu cho 1 tu·∫ßn

**Endpoint:** `POST /api/schedules/create-weekly`

**M√¥ t·∫£:** T·∫°o th·ªùi kh√≥a bi·ªÉu cho t·∫•t c·∫£ l·ªõp trong m·ªôt kh·ªëi l·ªõp c·ª• th·ªÉ cho 1 tu·∫ßn.

**Permissions:** `admin`, `manager`

**Request Body:**

```json
{
  "academicYear": "2024-2025",
  "gradeLevel": "12",
  "weekNumber": 1,
  "scheduleType": "MONDAY_TO_SATURDAY",
  "startDate": "2024-09-02",
  "endDate": "2024-09-07"
}
```

**Parameters:**

- `academicYear` (required): NƒÉm h·ªçc (format: YYYY-YYYY)
- `gradeLevel` (required): Kh·ªëi l·ªõp (1-12)
- `weekNumber` (optional): S·ªë tu·∫ßn (1-52, default: 1)
- `scheduleType` (optional): Lo·∫°i l·ªãch h·ªçc
  - `"MONDAY_TO_SATURDAY"` (default): Th·ª© 2 ƒë·∫øn th·ª© 7
  - `"MONDAY_TO_FRIDAY"`: Th·ª© 2 ƒë·∫øn th·ª© 6
- `startDate` (optional): Ng√†y b·∫Øt ƒë·∫ßu tu·∫ßn (format: YYYY-MM-DD)
- `endDate` (optional): Ng√†y k·∫øt th√∫c tu·∫ßn (format: YYYY-MM-DD)

**üìÖ C√°ch t√≠nh ng√†y:**

**Option 1: T·ª± ƒë·ªông t√≠nh to√°n (kh√¥ng cung c·∫•p startDate/endDate)**

```json
{
  "academicYear": "2024-2025",
  "gradeLevel": "12",
  "weekNumber": 1,
  "scheduleType": "MONDAY_TO_SATURDAY"
}
```

- H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t√≠nh to√°n ng√†y d·ª±a tr√™n `academicYear.startDate` v√† `weekNumber`
- Tu·∫ßn 1 = ng√†y b·∫Øt ƒë·∫ßu nƒÉm h·ªçc
- Tu·∫ßn 2 = ng√†y b·∫Øt ƒë·∫ßu nƒÉm h·ªçc + 7 ng√†y
- V√† c·ª© th·∫ø...

**Option 2: T√πy ch·ªânh ng√†y (cung c·∫•p startDate/endDate)**

```json
{
  "academicYear": "2024-2025",
  "gradeLevel": "12",
  "weekNumber": 1,
  "scheduleType": "MONDAY_TO_SATURDAY",
  "startDate": "2024-09-02",
  "endDate": "2024-09-07"
}
```

- S·ª≠ d·ª•ng ng√†y t√πy ch·ªânh thay v√¨ t√≠nh to√°n t·ª± ƒë·ªông
- `startDate` v√† `endDate` ph·∫£i ƒë∆∞·ª£c cung c·∫•p c√πng nhau
- Kho·∫£ng c√°ch gi·ªØa 2 ng√†y kh√¥ng ƒë∆∞·ª£c qu√° 7 ng√†y
- `endDate` ph·∫£i sau `startDate`

**Response Success (201):**

```json
{
  "success": true,
  "message": "Weekly schedule created successfully",
  "data": {
    "weekNumber": 1,
    "startDate": "2024-09-02T00:00:00.000Z",
    "endDate": "2024-09-07T00:00:00.000Z",
    "scheduleType": "MONDAY_TO_SATURDAY",
    "dateSource": "custom",
    "classesProcessed": 4,
    "weeklySchedulesCreated": 4,
    "totalLessonsCreated": 120,
    "classes": [
      {
        "className": "12A1",
        "gradeLevel": "12",
        "homeroomTeacher": "Nguy·ªÖn VƒÉn A"
      },
      {
        "className": "12A2",
        "gradeLevel": "12",
        "homeroomTeacher": "Tr·∫ßn Th·ªã B"
      }
    ]
  }
}
```

**Response Error (400):**

```json
{
  "success": false,
  "message": "Validation error",
  "errors": ["Academic year is required", "Grade level is required"]
}
```

### 2. L·∫•y th·ªùi kh√≥a bi·ªÉu theo l·ªõp v√† tu·∫ßn

**Endpoint:** `GET /api/schedules/class/:className/:academicYear/:weekNumber`

**M√¥ t·∫£:** L·∫•y th·ªùi kh√≥a bi·ªÉu chi ti·∫øt c·ªßa m·ªôt l·ªõp trong m·ªôt tu·∫ßn c·ª• th·ªÉ.

**Permissions:** T·∫•t c·∫£ user types (t·ª± ƒë·ªông l·ªçc theo quy·ªÅn)

**URL Parameters:**

- `className`: T√™n l·ªõp (v√≠ d·ª•: 12A1)
- `academicYear`: NƒÉm h·ªçc (format: YYYY-YYYY)
- `weekNumber`: S·ªë tu·∫ßn (1-52)

**Example URL:**

```
GET /api/schedules/class/12A1/2024-2025/1
```

**Response Success (200):**

```json
{
  "success": true,
  "message": "Weekly schedule retrieved successfully",
  "data": {
    "class": {
      "className": "12A1",
      "gradeLevel": "12"
    },
    "weeklySchedule": {
      "weekNumber": 1,
      "startDate": "2024-09-02T00:00:00.000Z",
      "endDate": "2024-09-07T00:00:00.000Z",
      "lessons": [
        {
          "_id": "64f8b9c123456789abcdef01",
          "lessonId": "12A1-2024-2025-W1-MON-P1",
          "type": "regular",
          "status": "scheduled",
          "scheduledDate": "2024-09-02T00:00:00.000Z",
          "dayOfWeek": "Th·ª© 2",
          "dayNumber": 1,
          "subject": {
            "_id": "64f8b9c123456789abcdef02",
            "subjectName": "To√°n h·ªçc",
            "subjectCode": "MATH"
          },
          "teacher": {
            "_id": "64f8b9c123456789abcdef03",
            "name": "Nguy·ªÖn VƒÉn A",
            "email": "nguyenvana@school.com"
          },
          "substituteTeacher": null,
          "timeSlot": {
            "_id": "64f8b9c123456789abcdef04",
            "period": 1,
            "startTime": "07:00",
            "endTime": "07:45",
            "type": "morning"
          },
          "notes": "Ti·∫øt h·ªçc ƒë·∫ßu ti√™n c·ªßa nƒÉm h·ªçc"
        }
      ]
    }
  }
}
```

### 3. L·∫•y th·ªùi kh√≥a bi·ªÉu gi√°o vi√™n theo tu·∫ßn

**Endpoint:** `GET /api/schedules/teacher/:teacherId/:academicYear/:weekNumber`

**M√¥ t·∫£:** L·∫•y l·ªãch d·∫°y c·ªßa m·ªôt gi√°o vi√™n trong m·ªôt tu·∫ßn c·ª• th·ªÉ.

**Permissions:** `admin`, `manager`, `teacher` (ch·ªâ c√≥ th·ªÉ xem l·ªãch c·ªßa m√¨nh)

**URL Parameters:**

- `teacherId`: ID c·ªßa gi√°o vi√™n
- `academicYear`: NƒÉm h·ªçc (format: YYYY-YYYY)
- `weekNumber`: S·ªë tu·∫ßn (1-52)

**Example URL:**

```
GET /api/schedules/teacher/64f8b9c123456789abcdef03/2024-2025/1
```

**Response Success (200):**

```json
{
  "success": true,
  "message": "Teacher weekly schedule retrieved successfully",
  "data": {
    "teacherId": "64f8b9c123456789abcdef03",
    "academicYear": "2024-2025",
    "weekNumber": 1,
    "startDate": "2024-09-02T00:00:00.000Z",
    "endDate": "2024-09-07T00:00:00.000Z",
    "totalLessons": 15,
    "lessons": [
      {
        "_id": "64f8b9c123456789abcdef01",
        "lessonId": "12A1-2024-2025-W1-MON-P1",
        "type": "regular",
        "status": "scheduled",
        "scheduledDate": "2024-09-02T00:00:00.000Z",
        "dayOfWeek": "Th·ª© 2",
        "dayNumber": 1,
        "subject": {
          "_id": "64f8b9c123456789abcdef02",
          "subjectName": "To√°n h·ªçc",
          "subjectCode": "MATH"
        },
        "class": {
          "_id": "64f8b9c123456789abcdef04",
          "className": "12A1",
          "gradeLevel": "12"
        },
        "timeSlot": {
          "_id": "64f8b9c123456789abcdef05",
          "period": 1,
          "startTime": "07:00",
          "endTime": "07:45",
          "type": "morning"
        },
        "notes": "Ghi ch√∫ b√†i h·ªçc"
      }
    ]
  }
}
```

**üîí Quy·ªÅn truy c·∫≠p:**

- **Admin/Manager**: C√≥ th·ªÉ xem l·ªãch c·ªßa b·∫•t k·ª≥ gi√°o vi√™n n√†o
- **Teacher**: Ch·ªâ c√≥ th·ªÉ xem l·ªãch c·ªßa ch√≠nh m√¨nh

### 4. Ki·ªÉm tra l·ªõp c√≥ t·ªìn t·∫°i kh√¥ng

**Endpoint:** `GET /api/schedules/check-class/:className/:academicYear`

**M√¥ t·∫£:** Ki·ªÉm tra xem m·ªôt l·ªõp c√≥ t·ªìn t·∫°i trong nƒÉm h·ªçc hay kh√¥ng.

**Permissions:** T·∫•t c·∫£ user types

**URL Parameters:**

- `className`: T√™n l·ªõp (v√≠ d·ª•: 12A1)
- `academicYear`: NƒÉm h·ªçc (format: YYYY-YYYY)

**Example URL:**

```
GET /api/schedules/check-class/12A1/2024-2025
```

**Response Success (200):**

```json
{
  "success": true,
  "message": "Class check completed",
  "data": {
    "exists": true,
    "class": {
      "_id": "64f8b9c123456789abcdef01",
      "className": "12A1",
      "academicYear": "2024-2025",
      "gradeLevel": "12"
    }
  }
}
```

### 5. L·∫•y chi ti·∫øt lesson

**Endpoint:** `GET /api/schedules/lesson/:lessonId`

**M√¥ t·∫£:** L·∫•y th√¥ng tin chi ti·∫øt c·ªßa m·ªôt lesson c·ª• th·ªÉ.

**Permissions:** T·∫•t c·∫£ user types (t·ª± ƒë·ªông ki·ªÉm tra quy·ªÅn)

**URL Parameters:**

- `lessonId`: ID c·ªßa lesson

**Example URL:**

```
GET /api/schedules/lesson/64f8b9c123456789abcdef01
```

**Response Success (200):**

```json
{
  "success": true,
  "message": "Lesson detail retrieved successfully",
  "data": {
    "_id": "64f8b9c123456789abcdef01",
    "lessonId": "12A1-2024-2025-W1-MON-P1",
    "type": "regular",
    "status": "scheduled",
    "scheduledDate": "2024-01-15T00:00:00.000Z",
    "dayOfWeek": "Th·ª© 2",
    "dayNumber": 1,
    "subject": {
      "_id": "64f8b9c123456789abcdef02",
      "subjectName": "To√°n h·ªçc"
    },
    "teacher": {
      "_id": "64f8b9c123456789abcdef03",
      "name": "Nguy·ªÖn VƒÉn A",
      "email": "nguyenvana@school.com"
    },
    "class": {
      "_id": "64f8b9c123456789abcdef04",
      "className": "12A1"
    },
    "timeSlot": {
      "_id": "64f8b9c123456789abcdef05",
      "period": 1,
      "startTime": "07:00",
      "endTime": "07:45"
    },
    "notes": "Ghi ch√∫ b√†i h·ªçc"
  }
}
```

### 6. C·∫≠p nh·∫≠t m√¥ t·∫£ lesson

**Endpoint:** `PATCH /api/schedules/lessons/:lessonId/description`

**M√¥ t·∫£:** C·∫≠p nh·∫≠t m√¥ t·∫£/ghi ch√∫ cho m·ªôt lesson.

**Permissions:** `admin`, `manager`, `teacher` (ch·ªâ lesson c·ªßa m√¨nh)

**URL Parameters:**

- `lessonId`: ID c·ªßa lesson

**Request Body:**

```json
{
  "description": "N·ªôi dung m√¥ t·∫£ m·ªõi"
}
```

**Example URL:**

```
PATCH /api/schedules/lessons/64f8b9c123456789abcdef01/description
```

**Response Success (200):**

```json
{
  "success": true,
  "message": "Lesson description updated successfully",
  "data": {
    "_id": "64f8b9c123456789abcdef01",
    "lessonId": "12A1-2024-2025-W1-MON-P1",
    "notes": "N·ªôi dung m√¥ t·∫£ m·ªõi"
  }
}
```

### 7. X√≥a m√¥ t·∫£ lesson

**Endpoint:** `DELETE /api/schedules/lessons/:lessonId/description`

**M√¥ t·∫£:** X√≥a m√¥ t·∫£/ghi ch√∫ c·ªßa m·ªôt lesson.

**Permissions:** `admin`, `manager`, `teacher` (ch·ªâ lesson c·ªßa m√¨nh)

**URL Parameters:**

- `lessonId`: ID c·ªßa lesson

**Example URL:**

```
DELETE /api/schedules/lessons/64f8b9c123456789abcdef01/description
```

**Response Success (200):**

```json
{
  "success": true,
  "message": "Lesson description deleted successfully",
  "data": {
    "_id": "64f8b9c123456789abcdef01",
    "lessonId": "12A1-2024-2025-W1-MON-P1",
    "notes": null
  }
}
```

### 8. Ho√†n th√†nh lesson

**Endpoint:** `PATCH /api/schedules/lesson/:lessonId/complete`

**M√¥ t·∫£:** ƒê√°nh d·∫•u m·ªôt lesson ƒë√£ ho√†n th√†nh.

**Permissions:** `admin`, `manager`, `teacher` (ch·ªâ lesson c·ªßa m√¨nh)

**URL Parameters:**

- `lessonId`: ID c·ªßa lesson

**Example URL:**

```
PATCH /api/schedules/lesson/64f8b9c123456789abcdef01/complete
```

**Response Success (200):**

```json
{
  "success": true,
  "message": "Lesson completed successfully",
  "data": {
    "_id": "64f8b9c123456789abcdef01",
    "lessonId": "12A1-2024-2025-W1-MON-P1",
    "status": "completed"
  }
}
```

## üÜï T√≠nh NƒÉng M·ªõi

### 1. Th√¥ng Tin Ng√†y Trong Tu·∫ßn

T·∫•t c·∫£ API tr·∫£ v·ªÅ lessons ƒë·ªÅu c√≥ th√™m:

- `dayOfWeek`: T√™n ng√†y b·∫±ng ti·∫øng Vi·ªát ("Th·ª© 2", "Th·ª© 3", ...)
- `dayNumber`: S·ªë th·ª© t·ª± ng√†y (1-7, Ch·ªß nh·∫≠t = 7)

### 2. C·∫£i Thi·ªán Ti·∫øt Empty

- Ti·∫øt `empty` kh√¥ng c√≤n c√≥ `class` v√† `teacher`
- Ch·ªâ ti·∫øt `regular`, `makeup`, `fixed` m·ªõi c√≥ ƒë·∫ßy ƒë·ªß th√¥ng tin

### 3. API Nh·∫•t Qu√°n

- **`/class/:className/:academicYear/:weekNumber`**: L·∫•y TKB l·ªõp theo tu·∫ßn
- **`/teacher/:teacherId/:academicYear/:weekNumber`**: L·∫•y TKB gi√°o vi√™n theo tu·∫ßn
- **C·∫•u tr√∫c URL nh·∫•t qu√°n** gi·ªØa class v√† teacher

## üìä Lesson Types

- `regular`: Ti·∫øt h·ªçc b√¨nh th∆∞·ªùng
- `makeup`: Ti·∫øt h·ªçc b√π
- `empty`: Ti·∫øt tr·ªëng (kh√¥ng c√≥ class/teacher)
- `fixed`: Ti·∫øt c·ªë ƒë·ªãnh (Ch√†o c·ªù, Sinh ho·∫°t)

## üîß Frontend Integration

### TypeScript Code Example

```typescript
import api from "./api.config";

// L·∫•y th·ªùi kh√≥a bi·ªÉu l·ªõp theo tu·∫ßn
export const getClassWeeklySchedule = async ({
  className,
  academicYear,
  weekNumber,
}: {
  className: string;
  academicYear: string;
  weekNumber: number;
}) => {
  const res = await api.get(
    `/api/schedules/class/${className}/${academicYear}/${weekNumber}`
  );
  return res.data;
};

// L·∫•y th·ªùi kh√≥a bi·ªÉu gi√°o vi√™n theo tu·∫ßn
export const getTeacherWeeklySchedule = async ({
  teacherId,
  academicYear,
  weekNumber,
}: {
  teacherId: string;
  academicYear: string;
  weekNumber: number;
}) => {
  const res = await api.get(
    `/api/schedules/teacher/${teacherId}/${academicYear}/${weekNumber}`
  );
  return res.data;
};

// L·∫•y chi ti·∫øt lesson
export const getLessonDetail = async (lessonId: string) => {
  const res = await api.get(`/api/schedules/lesson/${lessonId}`);
  return res.data;
};

// C·∫≠p nh·∫≠t m√¥ t·∫£ lesson
export const updateLessonDescription = async (
  lessonId: string,
  description: string
): Promise<any> => {
  try {
    const response = await api.patch(
      `/api/schedules/lessons/${lessonId}/description`,
      { description }
    );
    return response.data;
  } catch (error) {
    throw error;
  }
};

// X√≥a m√¥ t·∫£ lesson
export const deleteLessonDescription = async (
  lessonId: string
): Promise<any> => {
  try {
    const response = await api.delete(
      `/api/schedules/lessons/${lessonId}/description`
    );
    return response.data;
  } catch (error) {
    throw error;
  }
};

// Ho√†n th√†nh lesson
export const completeLesson = async (lessonId: string): Promise<any> => {
  try {
    const response = await api.patch(
      `/api/schedules/lesson/${lessonId}/complete`
    );
    return response.data;
  } catch (error) {
    throw error;
  }
};
```

## üöÄ Testing

```bash
# T·∫°o th·ªùi kh√≥a bi·ªÉu
curl -X POST "http://localhost:3000/api/schedules/create-weekly" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "academicYear": "2024-2025",
    "gradeLevel": "12",
    "weekNumber": 1,
    "scheduleType": "MONDAY_TO_SATURDAY"
  }'

# L·∫•y th·ªùi kh√≥a bi·ªÉu l·ªõp theo tu·∫ßn
curl -X GET "http://localhost:3000/api/schedules/class/12A1/2024-2025/1" \
  -H "Authorization: Bearer YOUR_TOKEN"

# L·∫•y th·ªùi kh√≥a bi·ªÉu gi√°o vi√™n theo tu·∫ßn
curl -X GET "http://localhost:3000/api/schedules/teacher/TEACHER_ID/2024-2025/1" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## üìû H·ªó Tr·ª£

N·∫øu c√≥ v·∫•n ƒë·ªÅ g√¨, h√£y li√™n h·ªá backend team ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£! üéâ
